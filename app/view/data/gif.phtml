<?php
$videoUrl = $this->view->video;

$this->load( $this->getViewPath() . "header.phtml" );
?>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f4f4f4;
      margin: 0; padding: 20px; color: #333;
    }
    .container { max-width: 800px; margin: auto; background: #fff; padding: 20px;
      border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    input, button { font-size: 1rem; }
    input[type="text"], input[type="number"] {
      width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; margin-bottom: 10px;
    }
    button { background: #0078d7; color: #fff; border: none; padding: 10px 20px;
      border-radius: 6px; cursor: pointer; transition: 0.2s; }
    button:hover { background: #005fa3; }
    .progress { margin-top: 10px; font-size: 0.9rem; color: #555; }
    img { max-width: 100%; margin-top: 20px; border-radius: 8px; border: 1px solid #ccc; }
    a.download-link { display: inline-block; margin-top: 10px; text-decoration: none;
      background: #28a745; color: #fff; padding: 8px 16px; border-radius: 6px; }
  </style>
  <!-- æ—¢å­˜ã®éãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ç‰ˆã‚’ãã®ã¾ã¾åˆ©ç”¨ -->
  <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.9.4/dist/ffmpeg.min.js"></script>

<div class="container">
  <h2>ğŸ¬ MP4 â†’ GIF å¤‰æ›</h2>
  <p>å‹•ç”»URLã¨ã€GIFã®<strong>é•·è¾º</strong>ãƒ”ã‚¯ã‚»ãƒ«ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ï¼ˆæœªæŒ‡å®šã¯400pxï¼‰ã€‚CORSå¯¾å¿œURLæ¨å¥¨ã€‚</p>

  <input id="videoUrl" type="text" value="<?php $this->h->p($videoUrl); ?>" placeholder="https://example.com/video.mp4">
  <input id="size" type="number" min="1" step="1" value="400" placeholder="é•·è¾ºãƒ”ã‚¯ã‚»ãƒ«ï¼ˆä¾‹: 500ï¼‰">
  <button id="convertBtn">GIFã«å¤‰æ›</button>
  <div id="progress" class="progress"></div>

  <img id="preview" style="display:none;" alt="GIF preview">
  <a id="downloadLink" class="download-link" style="display:none;" download="output.gif">GIFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>
</div>

<script>
(async () => {
  const { createFFmpeg, fetchFile } = FFmpeg;
  const ffmpeg = createFFmpeg({ log: true });

  const progress = document.getElementById('progress');
  const preview = document.getElementById('preview');
  const downloadLink = document.getElementById('downloadLink');
  const btn = document.getElementById('convertBtn');

  async function ensureFFmpegLoaded() {
    if (!ffmpeg.isLoaded()) {
      progress.textContent = 'FFmpegèª­ã¿è¾¼ã¿ä¸­...';
      await ffmpeg.load();
    }
  }

  function safeUnlink(path) {
    try { ffmpeg.FS('unlink', path); } catch (e) { /* å­˜åœ¨ã—ãªã„ãªã‚‰ç„¡è¦– */ }
  }

  btn.addEventListener('click', async () => {
    try {
      const url = document.getElementById('videoUrl').value.trim();
      const sizeInput = document.getElementById('size')?.value?.trim() ?? '';
      const target = Math.max(1, parseInt(sizeInput || '400', 10)); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ400

      if (!url) { alert('å‹•ç”»URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

      btn.disabled = true;
      preview.style.display = 'none';
      downloadLink.style.display = 'none';
      progress.textContent = '';

      // âœ… 2å›ç›®ä»¥é™ã¯ãƒ­ãƒ¼ãƒ‰ã—ãªã„
      await ensureFFmpegLoaded();

      progress.textContent = 'å‹•ç”»å–å¾—ä¸­...';
      const videoData = await fetchFile(url);

      // å‰å›ã®ç”Ÿæˆç‰©ã‚’æƒé™¤
      safeUnlink('input.mp4');
      safeUnlink('palette.png');
      safeUnlink('output.gif');

      ffmpeg.FS('writeFile', 'input.mp4', videoData);

      // é•·è¾º target px ã®ã‚¹ã‚±ãƒ¼ãƒ«å¼
      const scaleExpr = `scale='if(gte(iw,ih),${target},-1)':'if(gte(iw,ih),-1,${target})':flags=lanczos`;

      progress.textContent = 'é«˜ç”»è³ªãƒ‘ãƒ¬ãƒƒãƒˆç”Ÿæˆä¸­...';
      await ffmpeg.run('-i', 'input.mp4', '-vf', `fps=15,${scaleExpr},palettegen`, 'palette.png');

      progress.textContent = `GIFå¤‰æ›ä¸­ï¼ˆé•·è¾º ${target}pxï¼‰...`;
      await ffmpeg.run(
        '-i', 'input.mp4',
        '-i', 'palette.png',
        '-filter_complex', `fps=15,${scaleExpr}[x];[x][1:v]paletteuse`,
        '-loop', '0',
        'output.gif'
      );

      progress.textContent = 'GIFå‡ºåŠ›ä¸­...';
      const data = ffmpeg.FS('readFile', 'output.gif');
      const blob = new Blob([data.buffer], { type: 'image/gif' });
      const gifUrl = URL.createObjectURL(blob);

      preview.src = gifUrl;
      preview.style.display = 'block';
      downloadLink.href = gifUrl;
      downloadLink.style.display = 'inline-block';

      progress.textContent = 'âœ… å®Œäº†ã—ã¾ã—ãŸï¼';
    } catch (e) {
      console.error(e);
      progress.textContent = 'âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š' + (e?.message || e);
    } finally {
      btn.disabled = false;
    }
  });

  // è‡ªå‹•å®Ÿè¡Œã—ãŸã„å ´åˆã¯æœ‰åŠ¹åŒ–
  btn.click();
})();
</script>

<?php
$this->load( $this->getViewPath() . "footer.phtml" );
?>
