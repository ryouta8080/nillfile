<?php
$videoUrl = $this->view->video;

$this->load( $this->getViewPath() . "header.phtml" );

?>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    .container {
      max-width: 800px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    input, button {
      font-size: 1rem;
    }
    input[type="text"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-bottom: 10px;
    }
    button {
      background: #0078d7;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.2s;
    }
    button:hover {
      background: #005fa3;
    }
    .progress {
      margin-top: 10px;
      font-size: 0.9rem;
      color: #555;
    }
    img {
      max-width: 100%;
      margin-top: 20px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    a.download-link {
      display: inline-block;
      margin-top: 10px;
      text-decoration: none;
      background: #28a745;
      color: #fff;
      padding: 8px 16px;
      border-radius: 6px;
    }
  </style>
  <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.9.4/dist/ffmpeg.min.js"></script>
  
<div class="container">
  <h2>ğŸ¬ MP4 â†’ GIF å¤‰æ›</h2>
  <p>å‹•ç”»ã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆCORSå¯¾å¿œURLã‚’æ¨å¥¨ï¼‰ã€‚</p>

  <input id="videoUrl" type="text" value="<?php $this->h->p($videoUrl); ?>">
  <button id="convertBtn">GIFã«å¤‰æ›</button>
  <div id="progress" class="progress"></div>

  <img id="preview" style="display:none;" alt="GIF preview">
  <a id="downloadLink" class="download-link" style="display:none;" download="output.gif">GIFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>
</div>

<script>
(async () => {
  const { createFFmpeg, fetchFile } = FFmpeg;
  const ffmpeg = createFFmpeg({ log: true });

  const progress = document.getElementById('progress');
  const preview = document.getElementById('preview');
  const downloadLink = document.getElementById('downloadLink');
  const btn = document.getElementById('convertBtn');

  btn.addEventListener('click', async () => {
    const url = document.getElementById('videoUrl').value.trim();
    if (!url) {
      alert('å‹•ç”»URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }

   btn.disabled = true;
    progress.textContent = 'FFmpegèª­ã¿è¾¼ã¿ä¸­...';
    preview.style.display = 'none';
    downloadLink.style.display = 'none';

    await ffmpeg.load();

    progress.textContent = 'å‹•ç”»å–å¾—ä¸­...';
    const videoData = await fetchFile(url);
    ffmpeg.FS('writeFile', 'input.mp4', videoData);

    progress.textContent = 'é«˜ç”»è³ªãƒ‘ãƒ¬ãƒƒãƒˆç”Ÿæˆä¸­...';
    // ãƒ‘ãƒ¬ãƒƒãƒˆã‚’ä½œæˆï¼ˆç™ºè‰²æ”¹å–„ï¼‰
    await ffmpeg.run('-i', 'input.mp4', '-vf', 'fps=15,scale=600:-1:flags=lanczos,palettegen', 'palette.png');

    progress.textContent = 'GIFå¤‰æ›ä¸­ï¼ˆ600pxç¸®å°ï¼‰...';
    // ãƒ‘ãƒ¬ãƒƒãƒˆã‚’ä½¿ã£ã¦é«˜ç”»è³ªGIFã‚’ç”Ÿæˆ
    await ffmpeg.run(
      '-i', 'input.mp4',
      '-i', 'palette.png',
      '-filter_complex', 'fps=15,scale=600:-1:flags=lanczos[x];[x][1:v]paletteuse',
      '-loop', '0', 'output.gif'
    );

    progress.textContent = 'GIFå‡ºåŠ›ä¸­...';
    const data = ffmpeg.FS('readFile', 'output.gif');
    const blob = new Blob([data.buffer], { type: 'image/gif' });
    const gifUrl = URL.createObjectURL(blob);

    preview.src = gifUrl;
    preview.style.display = 'block';
    downloadLink.href = gifUrl;
    downloadLink.style.display = 'inline-block';

    progress.textContent = 'âœ… å®Œäº†ã—ã¾ã—ãŸï¼';
    btn.disabled = false;
  });
  
  btn.click();
})();
</script>

<?php

$this->load( $this->getViewPath() . "footer.phtml" );

?>